name: Code Quality Check

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  code-quality:
    name: PSScriptAnalyzer
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Code Quality Check
        shell: pwsh
        run: |
          Write-Host "Running PSScriptAnalyzer code quality check..." -ForegroundColor Cyan
          .\Scripts\Invoke-CodeQualityCheck.ps1 -FailOnErrors -ExportResults

      - name: Upload Code Quality Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: code-quality-reports
          path: CodeQualityReports/
          retention-days: 30

      - name: Comment PR with Results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        env:
          REPO: ${{ github.repository }}
          RUN_ID: ${{ github.run_id }}
        with:
          script: |
            const fs = require('fs');
            const reportPath = 'CodeQualityReports';
            const files = fs.readdirSync(reportPath);
            const jsonFile = files.find(f => f.endsWith('.json'));
            if (jsonFile) {
              const report = JSON.parse(fs.readFileSync(reportPath + '/' + jsonFile, 'utf8'));
              const summary = report.Summary;
              const status = summary.Errors === 0 ? 'PASS' : 'FAIL';
              const warning = summary.Errors > 0
                ? '\n\n> **This PR introduces code quality errors that must be fixed before merging.**'
                : '';
              const body = '## Code Quality Check ' + status + '\n\n'
                + '| Metric | Count |\n'
                + '|--------|------:|\n'
                + '| Files Analyzed | ' + summary.FilesAnalyzed + ' |\n'
                + '| Files with Issues | ' + summary.FilesWithIssues + ' |\n'
                + '| Errors | ' + summary.Errors + ' |\n'
                + '| Warnings | ' + summary.Warnings + ' |\n'
                + '| Total Issues | ' + summary.TotalIssues + ' |'
                + warning + '\n\n'
                + '[View detailed report](https://github.com/'
                + process.env.REPO + '/actions/runs/' + process.env.RUN_ID + ')';
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.name,
                body: body
              });
            }
